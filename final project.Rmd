---
title: "Final Project"
author: "Kanya Kreprasertkul"
date: "4/4/2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rvest)
library(tidyverse)
library(dplyr)
library(choroplethr)
library(choroplethrMaps)
library(jsonlite)
library(ggplot2)
```

```{r}
#download world university ranking data from the website
world_rank <- "https://cwur.org/2019-2020.php" %>%
  read_html() %>%
  html_table(fill = TRUE) %>%
  .[[1]]
```

```{r}
#number of universities in top ranking by country
n_country <- world_rank %>%
  select(Location) %>%
  group_by(Location) %>%
  summarise(total = n()) %>%
  arrange(desc(total))

#change column name to be compatible with choroplethr package
names(n_country) <- c("region", "value")
n_country$region <- tolower(n_country$region)
#change some of region name to be compatible with choroplethr package
n_country$region[n_country$region == "usa"] <- "united states of america"
n_country$region[n_country$region == "slovak republic"] <- "slovakia"
n_country$region[n_country$region == "serbia"] <- "republic of serbia"
```

```{r}
#get region data from choroplethrMaps package
data("country.regions")
#merge all regions from choroplethrMaps package and our dataset
n_country <- full_join(n_country, country.regions %>% select(region), by = "region")
n_country$value <- replace_na(n_country$value, 0)
```

```{r, warning = FALSE}
country_choropleth(n_country, title = "Number of universities in top ranking by country", num_colors = 9)
```

```{r}
#to see top countries
head(n_country, 10)
```

We can see that USA has the highest number of universities in top ranking. So, I want to look into education system in USA.

```{r}
#get only ranking of universities in USA
usa_world_rank <- world_rank %>%
  filter(Location == "USA")
```

```{r}
#import dataset from GitHub
tuition_cost <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-10/tuition_cost.csv')

salary_potential <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-10/salary_potential.csv')
salary_potential <- unique(salary_potential)

diversity_school <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-10/diversity_school.csv')
```

```{r}
#add percent of diversity
diversity_school <- diversity_school %>%
  mutate(percentage = 100 * enrollment / total_enrollment)
```

```{r}
#remove row containing NA and select only important columns
diversity_school <- diversity_school[!is.na(diversity_school$name), ] %>%
  select(-c("total_enrollment", "enrollment"))
#use spread() to distributes category and percentage
diversity_school2 <- spread(diversity_school, category, percentage) %>%
  select(name, state, White, Black, Hispanic, Asian, Women)
```

```{r}
usa_world_rank2 <- usa_world_rank
usa_world_rank2[(str_detect(usa_world_rank2$Institution, " – ")), ]$Institution <- str_replace(usa_world_rank2[(str_detect(usa_world_rank2$Institution, " – ")), ]$Institution, " – ", " at ")

usa_world_rank2[(str_detect(usa_world_rank2$Institution, " - ")), ]$Institution <- str_replace(usa_world_rank2[(str_detect(usa_world_rank2$Institution, " - ")), ]$Institution, " - ", " at ")

usa_world_rank2[(str_detect(usa_world_rank2$Institution, "–")), ]$Institution <- str_replace(usa_world_rank2[(str_detect(usa_world_rank2$Institution, "–")), ]$Institution, "–", " at ")

usa_world_rank2[(str_detect(usa_world_rank2$Institution, "-")), ]$Institution <- str_replace(usa_world_rank2[(str_detect(usa_world_rank2$Institution, "-")), ]$Institution, "-", " at ")

usa_world_rank2[(str_detect(usa_world_rank2$Institution, ", ")), ]$Institution <- str_replace(usa_world_rank2[(str_detect(usa_world_rank2$Institution, ", ")), ]$Institution, ", ", " at ")
```

```{r}
diversity_school2[(str_detect(diversity_school2$name, " -")), ]$name <- str_replace(diversity_school2[(str_detect(diversity_school2$name, " -")), ]$name, " -", " at ")

diversity_school2[(str_detect(diversity_school2$name, "-")), ]$name <- str_replace(diversity_school2[(str_detect(diversity_school2$name, "-")), ]$name, "-", " at ")
```

```{r}
#change university name (for further inner join)

diversity_school2$name[1264] <- usa_world_rank2$Institution[305]
diversity_school2$name[1751] <- usa_world_rank2$Institution[93]
diversity_school2$name[3562] <- usa_world_rank2$Institution[329]
diversity_school2$name[3642] <- usa_world_rank2$Institution[294]
diversity_school2$name[791] <- usa_world_rank2$Institution[259]
diversity_school2$name[432] <- usa_world_rank2$Institution[238]
diversity_school2$name[794] <- usa_world_rank2$Institution[308]
diversity_school2$name[4196] <- usa_world_rank2$Institution[16]
diversity_school2$name[3939] <- usa_world_rank2$Institution[21]
diversity_school2$name[4179] <- usa_world_rank2$Institution[26]
diversity_school2$name[4351] <- usa_world_rank2$Institution[27]
diversity_school2$name[3055] <- usa_world_rank2$Institution[31]
diversity_school2$name[3952] <- usa_world_rank2$Institution[37]

diversity_school2$name[3155] <- usa_world_rank2$Institution[38]
diversity_school2$name[4123] <- usa_world_rank2$Institution[39]
diversity_school2$name[4176] <- usa_world_rank2$Institution[51]
diversity_school2$name[1753] <- usa_world_rank2$Institution[63]
diversity_school2[(str_detect(diversity_school2$name, "University of Massachusetts")), ]$name <- str_replace(diversity_school2[(str_detect(diversity_school2$name, "University of Massachusetts")), ]$name, " at ", " ")

diversity_school2$name[3671] <- usa_world_rank2$Institution[70]
diversity_school2$name[933] <- usa_world_rank2$Institution[86]
diversity_school2$name[1491] <- usa_world_rank2$Institution[101]
diversity_school2$name[2289] <- usa_world_rank2$Institution[103]
diversity_school2$name[3883] <- usa_world_rank2$Institution[112]
diversity_school2$name[780] <- usa_world_rank2$Institution[127]
diversity_school2$name[2936] <- usa_world_rank2$Institution[139]
diversity_school2$name[4000] <- usa_world_rank2$Institution[151]
diversity_school2$name[3918] <- usa_world_rank2$Institution[167]
diversity_school2$name[802] <- usa_world_rank2$Institution[275]
diversity_school2$name[2089] <- usa_world_rank2$Institution[173]
diversity_school2$name[4379] <- usa_world_rank2$Institution[175]
diversity_school2$name[4035] <- usa_world_rank2$Institution[176]
diversity_school2$name[2464] <- usa_world_rank2$Institution[179]
diversity_school2$name[3552] <- usa_world_rank2$Institution[185]
diversity_school2$name[2754] <- usa_world_rank2$Institution[187]
diversity_school2$name[3914] <- usa_world_rank2$Institution[209]
diversity_school2$name[3689] <- usa_world_rank2$Institution[213]
diversity_school2$name[797] <- usa_world_rank2$Institution[215]
diversity_school2$name[4224] <- usa_world_rank2$Institution[220]
diversity_school2$name[4225] <- usa_world_rank2$Institution[257]
diversity_school2$name[3852] <- usa_world_rank2$Institution[270]
diversity_school2$name[4346] <- usa_world_rank2$Institution[274]
diversity_school2$name[4027] <- usa_world_rank2$Institution[279]
diversity_school2$name[4064] <- usa_world_rank2$Institution[296]
diversity_school2$name[3682] <- usa_world_rank2$Institution[298]
usa_world_rank2 <- data.frame(rbind(usa_world_rank2, usa_world_rank2[304, ]))
usa_world_rank2$Institution[304] <- diversity_school2$name[3319]
usa_world_rank2$Institution[359] <- diversity_school2$name[885]
diversity_school2$name[3917] <- usa_world_rank2$Institution[319]
diversity_school2$name[4530] <- usa_world_rank2$Institution[322]
diversity_school2$name[4071] <- usa_world_rank2$Institution[325]
diversity_school2$name[1371] <- usa_world_rank2$Institution[327]
diversity_school2$name[2824] <- usa_world_rank2$Institution[328]
diversity_school2$name[3953] <- usa_world_rank2$Institution[335]
diversity_school2$name[3688] <- usa_world_rank2$Institution[336]
diversity_school2$name[2758] <- usa_world_rank2$Institution[345]
diversity_school2$name[3460] <- usa_world_rank2$Institution[346]
```

```{r}
#diversity_school2[(str_detect(diversity_school2$name, "University of California")), ]$name <- str_replace(diversity_school2[(str_detect(diversity_school2$name, "University of California")), ]$name, " at ", ", ")
```

```{r}
diversity_school2[str_detect(diversity_school2$name, "Saint Benedict"), ]
diversity_school2[str_detect(diversity_school2$name, "SUNY"), ]
usa_world_rank2[str_detect(usa_world_rank2$Institution, "SUNY"), ]


which(str_detect(diversity_school2$name, "Simmons College") == TRUE)
which(str_detect(usa_world_rank2$Institution, "Simmons University") == TRUE)
```


```{r}
#usa_world_rank2 <- usa_world_rank2 %>% arrange(Institution)
setdiff(usa_world_rank2$Institution, diversity_school2$name)
#there are 17 universities that are not included in the diversity_school data
```

```{r}
rank_diversity_df <- inner_join(diversity_school2, usa_world_rank2, by = c("name" = "Institution")) %>%
  arrange(National.Rank) %>%
  mutate(Men = 100 - Women)

#change name of the university to be the official name
rank_diversity_df$name[6] <- "University of California, Berkeley"
rank_diversity_df$name[13] <- "University of California, Los Angeles"
rank_diversity_df$name[14] <- "University of Michigan, Ann Arbor"
rank_diversity_df$name[16] <- "University of Washington"
rank_diversity_df$name[17] <- "University of Illinois at Urbana-Champaign"
rank_diversity_df$name[19] <- "University of Wisconsin-Madison"
rank_diversity_df$name[23] <- "University of California, San Francisco"
rank_diversity_df$name[25] <- "University of Minnesota"
rank_diversity_df$name[32] <- "Rutgers University-New Brunswick"
rank_diversity_df$name[34] <- "University of California, Davis"
rank_diversity_df$name[40] <- "University of California, Irvine"
rank_diversity_df$name[41] <- "University of California, Santa Barbara"
rank_diversity_df$name[48] <- "Texas A&M University"
rank_diversity_df$name[53] <- "University of Maryland"
rank_diversity_df$name[67] <- "University of Missouri"
rank_diversity_df$name[72] <- "University of California, Riverside"
rank_diversity_df$name[75] <- "University of California, Santa Cruz"
rank_diversity_df$name[86] <- "University of Maryland, Baltimore"
rank_diversity_df$name[89] <- "Indiana University-Purdue University Indianapolis"
rank_diversity_df$name[92] <- "University of Tennessee"
```

```{r}
#scale percentage to 100%
rank_diversity_df <- rank_diversity_df %>%
  mutate(total = White + Black + Hispanic + Asian) %>%
  mutate(White2 = White * 100 / total, Black2 = Black * 100 / total, Hispanic2 = Hispanic * 100 / total, Asian2 = Asian * 100 / total)
```

```{r}
#gather by race
rank_diversity_df2 <- gather(rank_diversity_df, key = "Race", value = value, White2, Black2, Hispanic2, Asian2) %>% arrange(National.Rank)

rank_diversity_df2$Race <- str_replace(rank_diversity_df2$Race, "2", "")
```

```{r, fig.width = 8, fig.height = 8}
#use ggplot2 barplot to demonstrate the percentage of diversity
axis_lable1 <- c(rank_diversity_df$name[1:49])
axis_lable1 <- axis_lable1[order(-1:-49)]
ggplot(data = rank_diversity_df2[1:196, ], aes(x = name, y = value, fill = Race)) + geom_bar(stat = "identity") + coord_flip() + scale_x_discrete(limits = axis_lable1) + xlab("Institution") + ylab("Diversity Percentage") + ggtitle("Diversity Percentage of University in 1-50 Ranking")

axis_lable2 <- c(rank_diversity_df$name[50:96])
axis_lable2 <- axis_lable2[order(-1:-47)]
ggplot(data = rank_diversity_df2[197:384, ], aes(x = name, y = value, fill = Race)) + geom_bar(stat = "identity") + coord_flip() + scale_x_discrete(limits = axis_lable2) + xlab("Institution") + ylab("Diversity Percentage") + ggtitle("Diversity Percentage of University in 51-100 Ranking")
```

```{r, fig.width = 8, fig.height = 8}
#gather by sex
rank_diversity_df3 <- gather(rank_diversity_df, key = "Sex", value = value, Men, Women) %>%
  arrange(National.Rank)

ggplot(data = rank_diversity_df3[1:98, ], aes(x = name, y = value, fill = Sex)) + geom_bar(stat = "identity") + coord_flip() + scale_x_discrete(limits = axis_lable1) + xlab("Institution") + ylab("Sex Ratio") + ggtitle("Sex Ratio of University in 1-50 Ranking") + scale_fill_brewer(palette = "Paired")

ggplot(data = rank_diversity_df3[99:192, ], aes(x = name, y = value, fill = Sex)) + geom_bar(stat = "identity") + coord_flip() + scale_x_discrete(limits = axis_lable2) + xlab("Institution") + ylab("Sex Ratio") + ggtitle("Sex Ratio of University in 51-100 Ranking") + scale_fill_brewer(palette = "Paired")
```






```{r}
#import univrsity statistics (downloaded from kaggle)
university_stat <- fromJSON("schoolinfo.json")
#select only important columns
university_stat <- university_stat %>%
  select(`act-avg`, `sat-avg`, `acceptance-rate`, `percent-receiving-aid`, `cost-after-aid`, state, isPublic, tuition, displayName)
```

```{r}
university_stat2 <- university_stat
university_stat2[(str_detect(university_stat2$displayName, "--")), ]$displayName <- str_replace(university_stat2[(str_detect(university_stat2$displayName, "--")), ]$displayName, "--", " at ")

#"--"
```

```{r}
university_stat2$displayName[33]
diversity_school2$name[911]

university_stat2$displayName[19] <- diversity_school2$name[4351]
university_stat2$displayName[33] <- diversity_school2$name[911]
university_stat2$displayName[53] <- diversity_school2$name[3990]
university_stat2$displayName[54] <- diversity_school2$name[2911]
university_stat2$displayName[56] <- diversity_school2$name[1491]
university_stat2$displayName[61] <- diversity_school2$name[451]
university_stat2$displayName[115] <- diversity_school2$name[166]
university_stat2$displayName[84] <- diversity_school2$name[2789]
university_stat2$displayName[123] <- diversity_school2$name[4031]
university_stat2$displayName[98] <- diversity_school2$name[3671]
university_stat2$displayName[193] <- diversity_school2$name[1751]
university_stat2$displayName[100] <- diversity_school2$name[3884]
university_stat2$displayName[109] <- diversity_school2$name[4164]
```


```{r}
university_stat2[str_detect(university_stat2$displayName, "University of Tennessee"), ]
diversity_school2[str_detect(diversity_school2$name, "University of Tennessee"), ]
usa_world_rank2[str_detect(usa_world_rank2$Institution, "Pittsburgh"), ]

which(str_detect(diversity_school2$name, "University of Tennessee at Knoxville") == TRUE)
which(str_detect(university_stat2$displayName, "University of Tennessee") == TRUE)
```

```{r}
# compare these 2 first because only a few rows needed to change
setdiff(university_stat2$displayName, diversity_school2$name)
#50
setdiff(rank_diversity_df$name[1:96], university_stat2$displayName)
```






```{r}

t <- left_join(salary_potential, tuition_cost, by = "name")

salary_potential$state_name <- gsub("-", " ", salary_potential$state_name)
names(salary_potential)[3] <- "state"

state_code <- tuition_cost %>%
  select(state, state_code) %>%
  unique()

# library(datasets)
# data(state_codes)
#install.packages("openintro")
library(openintro)
salary_potential <- salary_potential %>% 
  mutate(state_code = state2abbr(state))
#state2abbr(state)
```

```{r}
union(t$name,salary_potential$name)

```

```{r}
tuition_cost[duplicated(tuition_cost$name),]
```
